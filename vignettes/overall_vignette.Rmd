---
title: "Caribou Resource Selection Probability Function package"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Caribou Resource Selection Probability Function package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction
This package implements the caribou resource selection probability functions (RSPF) described in [Hornseth and Rempel (2018)](https://doi.org/10.1139/cjz-2015-0101) in R. They were previously written in LSL and the goal of this package is to make them more accessible to a wider range of users. Although the LSL code is what this implementation is based on there are some differences which will be pointed out where they occur.  

```{r setup}
devtools::load_all()
pthBase <- "../tests/testthat/data/"
```

## The Data
Several different data sets are used in the model to describe conditions that affect caribou habitat selection. These include types of forest, wetland, eskers, and linear features. There are also several data sets used to update this information using more recent data and disturbance histories. The table below describes each data set, its source and what it is used for. 

| Name                            | Description                                                     | Purpose                                                                                                                                 | Source                                                                           |
|---------------------------------|-----------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
| Provincial landcover (PLC)      | 27 land-cover classes interpreted from 1999 to 2000 imagery     | Grouped into 7 resource types based on patterns believed sufficient to discriminate habitat selection                                   | [link](https://geohub.lio.gov.on.ca/datasets/7aa998fdf100434da27a41f1c637382c)   |
| Eskers                          | Location of eskers                                              | Used to calculate the density of eskers                                                                                                 | Rob Rempel                                                                       |
| Roads                           | Road network                                                    | Combined to calculate density of linear features which was used as a proxy for human disturbance                                        | Josie Hughes MNRFwithORN                                                         |
| Utilities                       | Transmission lines, pipelines etc.                              | Combined to calculate density of linear features which was used as a proxy for human disturbance                                        | [link](https://geohub.lio.gov.on.ca/datasets/mnrf::utility-line)                 |
| Rail                            | Rail network                                                    | Combined to calculate density of linear features which was used as a proxy for human disturbance                                        | [link](https://geohub.lio.gov.on.ca/datasets/mnrf::ontario-railway-network-orwn) |
| Forest resource inventory (FRI) | MNRF data on composition of forests                             | Used to update the PLC based forest type if it had been disturbed since 2001 or if it was disturbed before 2001 and the age is now > 35 | Josie Hughes                                                                     |
| Age                             | Age of forest stands in 10 year classes                         | Used to determine if PLC should be updated                                                                                              | Josie Hughes                                                                     |
| Natural disturbance             | Fire, wind or insect damage since 1990 (ie 10 years before PLC) | Used to determine if PLC should be updated and to set forest classes to 0 if > 35% disturbed                                                                                              | Stephen Mayer, OFRI Disturbance History database                                 |
| Harvest disturbance             | Whether a stand was harvested after PLC data collection         | Used to determine if PLC should be updated and to set forest classes to 0 if > 35% disturbed                                                                                              | Stephen Mayer, OFRI Disturbance History database                                 |
| Anthropogenic disturbance       | Presence of anthropogenic disturbance                           | Used to determine if PLC should be updated and to set forest classes to 0 if > 35% disturbed                                                                                              | Presence of any linear features                                                  |



## Simple Example
The example data set loaded below includes a small area in the Churchill caribou range that we will use as an example. The PLC and FRI data are converted to resource types based on look up tables provided in the package and the friLU which converts the forest units in the raster to regional forest units which are then converted to resource types.

```{r load data}
# load example data and classify plc and fri into Resource Types
plcD = raster(paste0(pthBase, "plc", ".tif")) %>% 
  reclassPLC()
eskerDras = raster(paste0(pthBase, "eskerTif", ".tif"))
eskerDshp = st_read(paste0(pthBase, "esker", ".shp"), quiet = TRUE)
friD = raster(paste0(pthBase, "fri", ".tif")) %>%
  reclassFRI(friLU = read.csv(paste0(pthBase, "friLU", ".csv"),
                                             stringsAsFactors = FALSE) %>%
               mutate(RFU = toupper(RFU) %>% stringr::str_replace("HRDMW", "HRDMX")))
ageD = raster(paste0(pthBase, "age", ".tif"))
natDistD = raster(paste0(pthBase, "natDist", ".tif"))
anthroDistD = raster(paste0(pthBase, "anthroDist", ".tif"))
harvD = raster(paste0(pthBase, "harv", ".tif"))
linFeatDras = raster(paste0(pthBase, "linFeatTif", ".tif"))
projectPolyD = st_read(paste0(pthBase, "projectPoly", ".shp"), quiet = TRUE)
linFeatDshp = st_read(paste0(pthBase, "linFeat", ".shp"), quiet = TRUE)
roadsD = st_read(paste0(pthBase, "roads.shp"), quiet = TRUE)
railD = st_read(paste0(pthBase, "rail.shp"), quiet = TRUE)
utilitiesD = st_read(paste0(pthBase, "utilities.shp"), quiet = TRUE)
```

`caribouHabitat` is the primary function in the package. It will prepare the data, process it into the explanatory variables in the Hornseth and Rempel RSPF models and then calculate the probability of habitat use in each season at each location. The function can be run in several different ways, but the simplest is to provide spatial objects for each data set. Other required arguments for the function are a lookup table that converts the forest units used in the FRI data to the regional forest units (RFUs) used in the model, and the name of the caribou range that the project is located in. In this case we also supply the area of the window used to calculate a moving window average of the input variables, this is only for the purpose of keeping the example data small and should not be supplied in most cases. 

```{r caribouHabitat1}
carHab1 <- caribouHabitat(
  landCover = plcD , 
  esker = eskerDras, 
  updatedLC = friD , 
  age = ageD, 
  natDist = natDistD, 
  anthroDist = anthroDistD, 
  harv = harvD,
  linFeat = linFeatDras, 
  projectPoly = projectPolyD,
  caribouRange = "Churchill", 
  #padFocal = TRUE, # assume data outside area is 0 for all variables
  winArea = 500 # only use in examples, leave as default for correct results
)
```

The `caribouHabitat` function returns an S4 object with the class `CaribouHabitat` which has slots for the input data, the processed data, and the results. To access the results as a RasterStack object that can be used for plotting or graphing use the `results` function.

```{r results1}
str(carHab1, max.level = 2, give.attr = FALSE)
results(carHab1)
```

You can also create a plot of the results directly from the `CaribouHabitat` object. If `tmap` is installed it will be used to make a plot or if it is not `plot.raster` will be used. You can provide the season you wish to display and additional arguments that will be passed on to either `qtm` or `plot.raster`.  

```{r plot1, fig.width=8, fig.height=5}
plot(carHab1, season = c("Fall", "Summer"))
```

## Example with padding

In most cases you will have a project area that is smaller than the environmental data sets available. For our example we will create this project area by selecting a rectangle inside our example data set. 

```{r create projPoly}
ext <- raster::extent(plcD) - 10000

projectPolyD2 <- st_bbox(ext) %>% st_as_sfc() %>% st_as_sf() %>% st_set_crs(st_crs(plcD))
```

The information that is outside our project area is still useful for preventing edge effects in our results. To use this data you can set `padProjPoly = TRUE` in the `caribouHabitat` call which will set a buffer around the project area based on the size of the moving window used to scale variables for that range. 

```{r caribouHabitat2}
# Use if no updatedLC or disturbance are provided then all info will come from
# that plc which will be easier to compare
carHab2 <- caribouHabitat(
  landCover = plcD, 
  esker = eskerDshp, 
  linFeat = linFeatDshp, 
  projectPoly = projectPolyD2,
  caribouRange = "Churchill", 
  padProjPoly = TRUE, 
  winArea = 500
)
```

```{r inspect padded, fig.width=8, fig.height=5}
tmap::qtm(plcD, raster = "black")+
  tmapCatRast(carHab2@landCover, lbls = raster::levels(carHab2@landCover)[[1]][[2]], ttle = "PLC")+
  tmap::qtm(carHab2@projectPoly, fill = NULL, borders = "black")
```

The black area on the map above shows the extent of the original plc data, the raster shows the plc data that has been cropped to a buffer around projectPoly which is the black rectangle.  

```{r compare pad, fig.width=8, fig.height=5}
carHab3 <- caribouHabitat(
  landCover = plcD, 
  esker = eskerDshp, 
  linFeat = linFeatDshp, 
  projectPoly = projectPolyD2,
  caribouRange = "Churchill",
  winArea = 500
)

carHab4 <- caribouHabitat(
  landCover = plcD, esker = eskerDshp, 
  linFeat = linFeatDshp,
  projectPoly = projectPolyD2,
  caribouRange = "Churchill", 
  padProjPoly = FALSE, 
  padFocal = TRUE,
  winArea = 500
)

st_area(projectPolyD2)


plot(carHab2, season = "Fall", title = "Pad with data outside project", 
     raster.breaks = c(0, 0.025, 0.05, 0.1, 0.15, 0.2, 0.3, 0.4, 0.5, 1), 
     layout.legend.outside = TRUE)+
  tmap::qtm(carHab3@projectPoly, fill = NULL, borders = "red", 
            shape.is.master = TRUE)

plot(carHab3, season = "Fall", title = "No padding", 
     raster.breaks = c(0, 0.025, 0.05, 0.1, 0.15, 0.2, 0.3, 0.4, 0.5, 1),
     layout.legend.outside = TRUE)+
  tmap::qtm(carHab3@projectPoly, fill = NULL, borders = "red", 
            shape.is.master = TRUE)

plot(carHab4, season = "Fall", title = "Pad with 0 outside project", 
     raster.breaks = c(0, 0.025, 0.05, 0.1, 0.15, 0.2, 0.3, 0.4, 0.5, 1),
     layout.legend.outside = TRUE)+
  tmap::qtm(carHab3@projectPoly, fill = NULL, borders = "red", 
            shape.is.master = TRUE)

```

The difference is large in this example because the project area is very small compared to the window size. The example with no padding is the default because it prevents users from relying on questionable results. The example with padding based on a larger data set is the preferred option since it makes use of all available information but it is not the default because it should only be used when the data provided is larger than the project area. The version where cells are padded with 0s gives results but they can be misleading. Based on the PLC data in the previous map you can see that there is one DEC cell just outside the projectPoly on the right. DEC has a strong negative effect on caribou habitat use so in the version padded with data cells on the right edge have lower probability of use than in the version with 0s as padding. In the top left corner the values in the version with 0s as padding are lower than with data padding because the cells outside the projectPoly are 0 when taking the weighted sum of values in the window. Therefore it is highly recommended to provide data for the area around the project and to use padProjPoly = TRUE.  

## Example with other inputs
As mentioned above `caribouHabitat` can be called in several different ways. You can provide the data as filepaths instead of spatial objects, you can provide the eskers and linear features as vector files which will be updated, and you can provide roads, rail, and utilities as a list to be combined into the linear features. 

```{r carbiouHabitat4}
carHab4 <- caribouHabitat(
  landCover = plcD, 
  esker = eskerDshp, 
  updatedLC = friD,
  age = ageD,
  natDist = natDistD,
  anthroDist = anthroDistD,
  harv = harvD,
  linFeat = list(roads = roadsD, rail = railD, utilities = utilitiesD),
  projectPoly = projectPolyD,
  caribouRange = "Churchill",
  winArea = 500
)
```

## Example of updating an existing object
In some cases you may want to update an existing object with new data for one or more of the input data sets. This can be done using `updateCaribou`.

For example we can create several data sets that show roads expanding across our study are and what effect this will have on caribou habitat. Since the only dataset that is changing is the linear features it will be faster to use `updateCaribou` rather than `caribouHabitat`.

```{r updateCaribou, fig.width=6, fig.height=6}
# Create series of data sets
ext <- raster::extent(linFeatDras)

height <- dim(linFeatDras)[1]/4

linFeatDras1 <- linFeatDras[1:height, , drop = FALSE] %>%
  raster::extend(linFeatDras, value = 0)
linFeatDras2 <- linFeatDras[1:(height*2), , drop = FALSE] %>%
  raster::extend(linFeatDras, value = 0)
linFeatDras3 <- linFeatDras[1:(height*3), , drop = FALSE] %>%
  raster::extend(linFeatDras, value = 0)

par(mfrow = c(2, 2))
plot(linFeatDras1)
plot(linFeatDras2)
plot(linFeatDras3)
plot(linFeatDras)


# Run caribouHabitat to process all the data once
carHabLF1 <- caribouHabitat(
  landCover = plcD,
  esker = eskerDras,
  updatedLC = friD, 
  age = ageD,
  natDist = natDistD, 
  anthroDist = anthroDistD, 
  harv = harvD,
  linFeat = linFeatDras1, 
  projectPoly = projectPolyD, 
  caribouRange = "Churchill", 
  padFocal = TRUE, 
  winArea = 500
)

# Run updateCaribou with the new linFeat raster
carHabLF2 <- updateCaribou(carHabLF1, newData = list(linFeat = linFeatDras2))

# compare results
plot(carHabLF1, season = "Fall", title = "linFeat 1", raster.breaks = 0:10/10, 
     legend.outside = TRUE)
plot(carHabLF2, season = "Fall", title = "linFeat 2", raster.breaks = 0:10/10, 
     legend.outside = TRUE)


```

You can see that there is a lower probability of caribou habitat use when there are more roads (linFeat 2).

## Example using Iteration

To go through a large number of updated data sets we can use the `purrr` package to iterate over different sets of data

```{r, fig.width=8, fig.height=5}
#library(purrr)

linFeatScns <- lst(linFeatDras2, linFeatDras3, linFeatDras)

# using carHabLF1 created above we run the update for all three datasets

linFeatResults <- purrr::map(
  linFeatScns,
  ~updateCaribou(carHabLF1, newData = list(linFeat = .x))
)

purrr::walk2(c(carHabLF1, linFeatResults), 
             c("linFeatDras1", names(linFeatResults)), 
             ~plot(.x, season = "Fall", title = .y, raster.breaks = 0:10/10,
                   legend.outside = TRUE) %>% print())


```

## Example with different coefficients
Different coefficients can be supplied using the `coefTable` argument and if those coefficients are standardized the data can be standarized by supplying the argument `doScale = TRUE`.
```{r}
carHabStd <- caribouHabitat(
  landCover = plcD,
  esker = eskerDras,
  natDist = natDistD, 
  anthroDist = anthroDistD, 
  harv = harvD,
  linFeat = linFeatDras, 
  projectPoly = projectPolyD, 
  caribouRange = "James Bay", 
  padFocal = TRUE, 
  winArea = 500, 
  coefTable = coefTableStd,
  doScale = TRUE
)
```

