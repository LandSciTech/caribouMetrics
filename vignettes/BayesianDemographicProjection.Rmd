---
title: "Bayesian Demographic Projection"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Bayesian Demographic Projection}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7, 
  fig.height = 3.5
)
```

```{r setup}
library(caribouMetrics)
library(ggplot2)
library(dplyr)

theme_set(theme_bw())
```

`caribouMetrics` includes several functions designed to allow users to explore the impacts of various factors that affect projections of caribou population dynamics using the Johnson et al. (2020) national models as a starting point.

A Bayesian model is fit that uses the national model as the priors and is updated based on a simulated or observed data set. The priors from the national model can also be modified to allow greater uncertainty or reflect different expectations.

### Using real observed data

```{r load-obs}
survObs <- read.csv(system.file("extdata/simSurvData.csv", package = "caribouMetrics"))
ageRatioObs <- read.csv(system.file("extdata/simAgeRatio.csv", package = "caribouMetrics"))
distObs <- read.csv(system.file("extdata/simDisturbance.csv", package = "caribouMetrics"))

survObs %>% group_by(Year) %>% 
  summarise(n_collars = n(),
            n_die = sum(event)) %>% 
  ggplot(aes(Year))+
  geom_line(aes(y = n_collars))+
  geom_col(aes(y = n_die))+
  labs(y = "Number of Collars (line) and deaths (bars)")

ageRatioObs %>% 
  ggplot(aes(Year, Count, fill = Class))+
  geom_col(position = "dodge")

distObs %>% ggplot(aes(Year, Anthro))+
  geom_line()

```

```{r mod-real}
mod_real <- caribouBayesianIPM(survData = survObs, ageRatio = ageRatioObs, 
                              disturbance = distObs, 
                              # only set to speed up vignette. Normally keep defaults.
                              Niter = 150, Nburn = 100)

mod_tbl <- getOutputTables(mod_real, 
                           simNational = getSimsNational(),
                           getKSDists = FALSE)

plotRes(mod_tbl,
        c("Recruitment", "Adult female survival", "Population growth rate"),
         labFontSize = 10)

```

From these graphs we can see that this local population seems to have slightly higher demographic rates than would have been predicted by the national model alone. Note that the population's response to anthropogenic disturbance in completely determined by the national model since there was 0% disturbance during the observation period.  

### Simulate observed data
We will simulate observations from a typical boreal caribou monitoring program that includes radio collars on some cows and annual aerial surveys to count the number of calves with the tracked cows. To run the simulations we need a data frame of the number of collars deployed in each year and a data frame of cow counts in each year. In addition we will provide parameters to create a disturbance scenario and set other parameters...

```{r sim-obs}
scn_params <- getScenarioDefaults(
  # Anthropogenic disturbance increases by 2% per year in observation perios and
  # 3% per year in projection period
  obsAnthroSlope = 2, projAnthroSlope = 3,
  # 20 years each of observations and projections
  obsYears = 20, projYears = 20,
  # Collaring program aims to keep 30 collars active
  collarCount = 30,
  # Collars are topped up every year
  collarInterval = 1,
  # Assume will see 2 cows in aerial survey for every collar deployed
  cowMult = 2
  )

sim_obs <- simulateObservations(
  scn_params, 
  # collars fall off after 4 years and are deployed in May and fall off in August
  collarNumYears = 4, collarOffTime = 8, collarOnTime = 5, 
  printPlot = TRUE)


sim_obs$simSurvObs %>% group_by(Year) %>% 
  summarise(ncollar = n(), ndeaths = sum(event), 
            ndropped = sum(exit == 5 & event == 0),
            nadded = sum(enter == 7), 
            survsCalving = sum(exit >= 6)) %>% 
  ggplot(aes(Year))+
  geom_line(aes(y = ncollar))+
  geom_col(aes(y = ndeaths))+
  labs(y = "Number of Collars (line) and deaths (bars)")

sim_obs$ageRatioOut %>% 
  ggplot(aes(Year, Count, fill = Class))+
  geom_col(position = "dodge")

sim_obs$simDisturbance %>% ggplot(aes(Year, Anthro))+
  geom_line()
```

```{r mod-sim-obs}
mod_sim <- caribouBayesianIPM(survData = sim_obs$simSurvObs,
                              ageRatio = sim_obs$ageRatioOut, 
                              disturbance = sim_obs$simDisturbance, 
                              # only set to speed up vignette. Normally keep defaults.
                              Niter = 150, Nburn = 100)
simNational <- getSimsNational()
mod_sim_tbl <- getOutputTables(mod_sim, exData = sim_obs$exData, 
                               paramTable = sim_obs$paramTable,
                               simNational = simNational,
                               getKSDists = FALSE)

plotRes(mod_sim_tbl,
        c("Recruitment", "Adult female survival", "Population growth rate"),
        labFontSize = 10)
```


### Comparing many scenarios

```{r many-scns, fig.height=8, fig.width=7}
eParsIn <- list()
eParsIn$collarOnTime <- 1
eParsIn$collarOffTime <- 12
eParsIn$collarNumYears <- 3

# adjust recruitment for delayed age of first reproduction
adjustR <- T 

simBig <- getSimsNational(adjustR = adjustR)

scns <- expand.grid(
  obsYears = 10, projYears = 10, collarCount = 100, cowMult = 2, collarInterval = 2,
  assessmentYrs = 1, iAnthro = 0, obsAnthroSlope = 0, projAnthroSlope = 0, 
  sQuantile = c(0.1, 0.5, 0.9), rQuantile = c(0.1, 0.5, 0.9), N0 = 1000
)
scResults <- runScnSet(
  scns, eParsIn, simBig, getKSDists = FALSE,
  # only set to speed up vignette. Normally keep defaults.
  Niter = 150, Nburn = 100)

plotRes(scResults,
        c("Recruitment", "Adult female survival", "Population growth rate"), 
        facetVars = c("rQuantile", "sQuantile"))

```


### Troubleshooting
The national model results are cached if the default values are used. This cache can but updated by running `getSimsNational(forceUpdate = TRUE)`




