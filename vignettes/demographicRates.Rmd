---
title: "demographicRates"
author: "Josie Hughes, Landscape Science & Technology Division, Environment & Climate Change Canada"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{demographicRates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
fig_caption: yes
---
This vignette will demonstrate the use of the demographic models in the package by recreating figures 3 and 5 from Johnson et. al. 2020. 

First we create a table of disturbance scenarios across a range of different levels of fire and anthropogenic disturbance.
```{r setup}
library(caribouMetrics)
library(ggplot2)

covTableSim <- expand.grid(Anthro = seq(0, 90, by = 2), 
                           Fire = seq(0, 70, by = 10)) 
covTableSim$polygon = paste0("Missisa_", covTableSim$Anthro + 1)
covTableSim$area = "FarNorth"
covTableSim$Total_dist = covTableSim$Anthro + covTableSim$Fire
covTableSim$fire_excl_anthro = covTableSim$Fire
```

Then we get two different samples of the coefficients from models M1 and M4. The sample of 500 will be used to determine an average while the sample of 35 will be used to demonstrate the variation of individual populations. 

```{r}
popGrowthPars <- demographicCoefficients(
  500,
  modelVersion = "Johnson",
  survivalModelNumber = "M1",
  recruitmentModelNumber = "M4",
  populationGrowthTable = popGrowthTableJohnsonECCC
)

popGrowthParsSmall <- demographicCoefficients(
  35,
  modelVersion = "Johnson",
  survivalModelNumber = "M1",
  recruitmentModelNumber = "M4",
  populationGrowthTable = popGrowthTableJohnsonECCC
)
```

Next we calculate the demographic rates predicted by the models. For the smaller sample we set `returnSample = TRUE` so that the results returned contain a row for each sample in each scenario. For the larger sample we set `returnSample = FALSE` and the result has one row for each scenario and includes summary statistics of the uncertainty across the samples. We did this twice, once with `ignorePrecision = TRUE` and once with `ignorePrecision = FALSE` to demonstrate the effect of considering the  variance among populations around the National mean in addition to the uncertainty about the coefficient estimates.

```{r}
rateSamples <- demographicRates(
  covTable = covTableSim,
  popGrowthPars = popGrowthParsSmall,
  ignorePrecision = FALSE,
  returnSample = TRUE,
  useQuantiles = TRUE
)

rateSummaries <- demographicRates(
  covTable = covTableSim,
  popGrowthPars = popGrowthPars,
  ignorePrecision = FALSE,
  returnSample = FALSE,
  useQuantiles = FALSE
)

rateSummariesIgnorePrecision <- demographicRates(
  covTable = covTableSim,
  popGrowthPars = popGrowthPars,
  ignorePrecision = TRUE,
  returnSample = FALSE,
  useQuantiles = FALSE
)
```
Prepare for graphing by randomly sorting the samples.
```{r}
theme_set(theme_bw())

rateSamples$rep = as.factor(rateSamples$replicate)
levels(rateSamples$rep) = sample(unique(rateSamples$replicate),
                                 replace = FALSE)
rateSamples$rep = as.character(rateSamples$rep)

rateSamples$fullGrp = paste(rateSamples$rep, rateSamples$Fire)
```
### No precision
Johnson 2020 model with parameter uncertainty but no precision. The bands are 2.5% and 97.5% prediction intervals
```{r parameterUncertaintyOnly,echo=FALSE, fig.width=10, fig.height=5}

base1 <- ggplot(data = rateSummariesIgnorePrecision, 
                aes(x = Anthro, y = S_bar, ymin = S_PIlow, ymax = S_PIhigh))+
  geom_line(colour = "black", size = 2)+
  geom_ribbon(alpha = 0.25)+
  xlab("Anthropogenic Disturbance (%)")+
  ylab("Adult Female Survival")+
  scale_y_continuous(limits = c(0.65, 1))+
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(0, 90), breaks = c(0, 20, 40, 60, 80))

base1

plot_recruitment3 <- ggplot(
  data = rateSummariesIgnorePrecision, 
  aes(x = Anthro, y = R_bar * 100, group = Fire, colour = Fire, type = Fire, 
      ymin = R_PIlow * 100, ymax = R_PIhigh * 100, fill = Fire)
  )+
  geom_line(size = 2)+
  geom_ribbon(alpha = 0.15, colour = NA)+
  scale_fill_gradient(low = "green", high = "red")+
  scale_colour_gradient(low = "green", high = "red")+
  scale_y_continuous(limits = c(0, 60), breaks = c(0, 10, 20, 30, 40, 50, 60))+
  scale_x_continuous(limits = c(0, 90), breaks = c(0, 20, 40, 60, 80))+
  xlab("Anthropogenic disturbance (%)")+
  ylab("Recruitment (calves per 100 cows)")
plot_recruitment3

```

### With precision
Johnson 2020 model with parameter uncertainty and precision. Faint coloured lines show example trajectories of expected demographic rates in sample populations, assuming each sample population is randomly distributed among quantiles of the beta distribution, and each population remains in the same quantile of the beta distribution as disturbance changes over time.
```{r withPrecision,echo=FALSE, fig.width=10, fig.height=5}
base1 <- ggplot(data = rateSummaries, 
                aes(x = Anthro, y = S_bar, ymin = S_PIlow, ymax = S_PIhigh))+
  geom_line(data = subset(rateSamples, Fire == 0), size = 0.5, 
            aes(x = Anthro, y = S_bar, group = rep, colour = rep), inherit.aes = FALSE)+
  geom_line(colour = "black", size = 2)+
  geom_ribbon(alpha = 0.25)+
  xlab("Anthropogenic Disturbance (%)")+
  ylab("Adult Female Survival")+
  scale_y_continuous(limits = c(0.65, 1))+
  theme(legend.position = "none")+
  scale_x_continuous(limits = c(0, 90), breaks = c(0, 20, 40, 60, 80))
base1

plot_recruitment3 <- ggplot(data = rateSummaries, 
                            aes(x = Anthro, y = R_bar * 100,  group = Fire,
                                colour = Fire, type = Fire))+
  geom_line(data = rateSamples,  
            aes(x = Anthro, y = R_bar * 100, group = fullGrp, colour = Fire),
            size = 0.5, alpha = 0.2, inherit.aes = FALSE)+
  geom_line(size = 2)+
  scale_colour_gradient(low = "green", high = "red")+
  scale_y_continuous(limits = c(0, 60),
                     breaks = c(0, 10, 20, 30, 40, 50, 60))+
  scale_x_continuous(limits = c(0, 90), breaks = c(0, 20, 40, 60, 80))+
  xlab("Anthropogenic disturbance (%)")+
  ylab("Recruitment (calves per 100 cows)")
plot_recruitment3

```

