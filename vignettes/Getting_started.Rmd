---
title: "Getting started"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction


This vignette provides an overview of how to use the caribouMetrics package. There are more detailed vignettes available for the `caribouHabitat` function (`vignette("caribouHabitat", package = "caribouMetrics")`) and for the demographic models (`vignette("caribouDemography", package = "caribouMetrics")`).



# `caribouHabitat()`
`caribouHabitat` is the function used to run the RSPF model. 

```{r setup, results=FALSE}
knitr::opts_chunk$set(warning = FALSE)

library(caribouMetrics)
library(dplyr)
library(raster)
library(sf)
library(ggplot2)

```

# Example Data
An example data set taken from part of the Nipigon caribou range in Ontario is provided with the package. It uses the provincial land cover classes to determine the `landCover`. As the RSPF is generated using a set of specific resource classes which may not match those of standard land-cover classes there is a re-classing function (`reclassPLC`) which uses a look-up table to convert Ontario provincial land cover classes into the correct resource classes to use in the RSPF model. Disturbance data sets can be converted from polygons of year of disturbance or time since disturbance using (`reclassDist`). In the example fire data with polygons containing year of disturbance are converted to a presence absence raster of cumulative disturbance over the past 30 years.


```{r data in}
# load data sets 
pth_base <- system.file("extdata", package = "caribouMetrics")

caribouRanges <- c("Pagwachuan", "Missisa", "Nipigon", "James Bay")

landCover <- raster(file.path(pth_base, "landCover.tif")) %>%
  reclassPLC()

esker <- read_sf(file.path(pth_base, "esker.shp"))

linFeat <- list(roads = read_sf(file.path(pth_base, 
                                       "roads.shp")),
                rail = read_sf(file.path(pth_base, "rail.shp")),
                utilities = read_sf(file.path(pth_base, "utilities.shp")))

natDist <- sf::st_read(file.path(pth_base, "fireAFFES2020.shp")) %>% 
  reclassDist(endYr = 2020, numCumYrs = 30, template = landCover, 
              dateField = "FIRE_YEAR")

anthroDist <- raster(file.path(pth_base, "anthroDist.tif"))

# make a polygon inside the bounding box of the rasters
singlePoly <- (raster::extent(landCover) - 30000) %>% st_bbox() %>%
  st_as_sfc() %>% st_as_sf() %>% st_set_crs(st_crs(landCover))

```


```{r disturbance}
disturb <- disturbanceMetrics(landCover = landCover,
                              linFeat = linFeat,  
                              natDist = natDist,
                              projectPoly = singlePoly)
```


# Demographic Models

Another feature of `caribouMetrics` is an implementation of the population dynamics models in *Science to inform policy: linking population dynamics to habitat for a threatened species in Canada* by Johnson et. al. (2020) and the "Environment Canada Scientific Assessment to Inform the Identification of Critical Habitat for Woodland Caribou (*Rangifer tarandus caribou*), Boreal Population, in Canada 2011 Update" report.
`demographicCoefficients()` selects coefficients for the chosen model and then samples them for each replicate. `demographicRates()` samples expected survival or recruitment rates based on samples of coefficient values and optionally the model precision. These are wrapper functions what use sensible defaults but lower level functions are also available.
 
```{r demographics}
demCoefs <- demographicCoefficients(replicates = 10)

# Compare the current conditions to a scenario with 10% more anthropogenic
# disturbance
exTable <- bind_rows(results(disturb),
                     results(disturb) %>% 
                       mutate(Anthro = Anthro + 10, 
                              Total_dist = Total_dist + 10))

demRates <- demographicRates(covTable = exTable,
                             popGrowthPars = demCoefs)

ggplot(demRates, aes(Anthro, S_bar))+
  geom_point()+
  geom_errorbar(aes(ymin = S_PIlow, ymax = S_PIhigh), width = 0.1)+
  scale_y_continuous(breaks = 5:10/10, limits = c(0.5,1))+
  xlab("Anthropogenic Disturbance (%)")+
  ylab("Adult Female Survival")+
  theme_bw()

```

Finally, we can model population growth using `caribouPopGrowth()` which is an implementation of the 2-stage population growth model used in Johnson et al. (2020) but with some differences described in Dyson et al. (in Prep). 

```{r}
popGrow <- caribouPopGrowth(N = c(2000, 2000), numSteps = 20,
                            R_bar = demRates$R_bar, 
                            S_bar = demRates$S_bar)

cbind(demRates[,1:5], popGrow)
```


*For additional details on functions in the package see the help documentation*

# References




