---
title: "Churchill Caribou Habitat 2020"
output:
  pdf_document: default
  html_document:
    df_print: paged
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

We implemented the caribou Resource Selection Probability Function (RSPF) developed by Hornseth and Rempel (2016) for the Churchill range using the most recent available data. 

```{r setup, include=FALSE}
# Current Situation in Churchill

devtools::load_all(".")
library(ggplot2)

# load data
pth_base <- "inputNV/ChurchillData/"


```

### The Data

```{r Datatable, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "  
| Name                              | Source                                                                                                                                                                                                |
|-----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Provincial land cover             | [Provincial Land Cover 2000](https://geohub.lio.gov.on.ca/datasets/provincial-land-cover)                                                                                                             |
| Eskers                            | [Quaternary Geology](https://www.mndm.gov.on.ca/en/mines-and-minerals/applications/ogsearth/quaternary-geology)                                                                                       |
| Roads                             | [Ontario Road Network](https://geohub.lio.gov.on.ca/datasets/mnrf::ontario-road-network-orn-segment-with-address) and [MNRF Road Segments](https://geohub.lio.gov.on.ca/datasets/mnrf-road-segments)  |
| Rail                              | [Ontario Railway Network](https://geohub.lio.gov.on.ca/datasets/mnrf::ontario-railway-network-orwn)                                                                                                   |
| Utilities                         | [Utility Line](https://geohub.lio.gov.on.ca/datasets/mnrf::utility-line)                                                                                                                              |
| Natural disturbance               | [Fire Disturbance Area](https://geohub.lio.gov.on.ca/datasets/fire-disturbance-area)                                                                                                                  |
| Anthropogenic disturbance         | MNRF Annual Report harvest data                                                                                                                                                                       |
| Forest resource inventory and age | Planning Composite Inventory                                                                                                                                                                          |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

```{r run, include=FALSE, cache=TRUE}
eskerD <- st_read(paste0(pth_base, "esker.shp"))
plcD <- raster(paste0(pth_base, "plc50.tif"))
roadD <- st_read(paste0(pth_base, "road_ORNMNRFCH2020.shp"))
railD <- st_read(paste0(pth_base, "rail.shp"))
utilD <- st_read(paste0(pth_base, "util2020.shp"))
natDistD <- raster(paste0(pth_base, "fireAFFES2020_50.tif"))
anthroDistD <- raster(paste0(pth_base, "harvMNRF2018_50.tif"))
friD <- raster(paste0(pth_base, "friPCIFRI2020.tif"))
ageD <- raster(paste0(pth_base, "agePCIFRI2020.tif"))
friLUD <- read.csv(paste0(pth_base, "PCIFRI2020LookUp.csv"))

projectPolyD <- st_read("./inputNV/caribouRanges/Caribou_Range_Boundary.shp", 
                        quiet = TRUE) %>% 
  filter(RANGE_NAME == "Churchill") %>% 
  st_transform(crs = st_crs(plcD))

caribouResults <- caribouHabitat(
  plc = plcD, 
  esker = eskerD, 
  #esker = eskerDen, 
  fri = friD, 
  age = ageD, 
  natDist = natDistD, 
  anthroDist = anthroDistD,
  harv = anthroDistD,
  #linFeat = linFeatDen,
  linFeat = list(roads = roadD, rail = railD,
                  utilities = utilD),
  projectPoly = projectPolyD, 
  friLU = friLUD, 
  caribouRange = "Churchill", 
  padProjPoly = TRUE, 
  eskerSave = paste0(pth_base, "eskerDen.tif"),
  linFeatSave = paste0(pth_base, "linFeatDen.tif")
) 
```

### Caribou probability of use
Probability of habitat use by caribou in the Churchill range based on the models developed by Hornseth and Rempel (2016) and the data sets described above.

```{r results1, fig.width=7.5, fig.height=6, echo=FALSE}
plot(caribouResults)
```

### Binary caribou use 
Hornseth and Rempel developed thresholds to determine whether habitat was selected or not by balancing false positive vs false negative errors using Youden's J with a cost of 5 so that errors that underestimate important habitat have a higher cost.

```{r results2, fig.width=7.5, fig.height=6, echo=FALSE}
tmap::qtm(calcBinaryUse(caribouResults, caribouResults@attributes$caribouRange), raster.title = "Binary caribou use", legend.outside = TRUE, raster.palette = "-cividis", raster.labels = c("No", "Yes"), raster.alpha = 0.5)
```


### Explanatory variables
Variables used in the model to predict the probability of caribou habitat use. These variables represent the proportion of each habitat type in a 5000 ha moving window, except for the eskers and linear features which represent the density of the feature in the 5000 ha moving window in m/ha. Note that the scales are different in each facet so colours should not be compared across facets.

```{r results3, fig.width=7.5, fig.height=10, echo=FALSE}

tmap::qtm(caribouResults@processedData[[c(1:6, 8:11)]] %>% 
            raster::mask(caribouResults@projectPoly),
          facets.free.scales = TRUE, 
          layout.legend.position = c("RIGHT", "BOTTOM"),
          layout.panel.labels = c("Dense conifer", "Dense deciduous", 
                                  "Open peatland", "Conifer peatland", "Water",
                                  "Mixed deciduous and conifer", "Sparse conifer",
                                  "Natural burn", "Linear features", 
                                  "Gravel esker"),
          raster.title = "")
```

### Model coefficients
The coefficients used in the RSPF model give an indication of which variables have a large impact on the probability of caribou habitat use.

```{r results4, fig.width=7.5, fig.height=5, echo=FALSE}
# log transform colout scale
log_both <- function(x){ifelse(x == 0, 0, log(abs(x)) * sign(x))}
exp_both <- function(x){exp(abs(x)) * sign(x)} # this is the inverse of log_both

log_both_trans <- 
  function(){
    scales::trans_new(name = 'log_both', 
              transform = log_both,
              inverse = exp_both)
  }

coefTableHR %>% filter(Range == "Churchill") %>% 
  mutate(Coefficient = round(Coefficient, 3), 
         sign = ifelse(Coefficient< 0, "plain", "bold")) %>% 
  ggplot(aes(Season, Variable, fill = Coefficient))+
  geom_tile()+
  geom_text(aes(label = Coefficient), col = "black")+
  scale_fill_gradient2()+
  theme_classic()+
  scale_y_discrete(labels = c("Dense conifer", "Constant", "Dense deciduous",
                              "Natural burn", "Gravel esker", "Open peatland",
                              "Conifer peatland", "Water", "Mixed",
                              "Sparse conifer", "Linear features"))
```
