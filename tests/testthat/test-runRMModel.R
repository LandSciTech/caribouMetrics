
test_that("Runs with defaults", {
  # reduce some defaults to make fast
  # note that the default csv does not match the default startYear
  expect_s3_class(runRMModel(startYear = 2009, Nchains = 1, Niter = 100, Nburn = 10,
                       Nthin = 2)$result,
            "rjags")
})

test_that("input tables are as expected",{
  # default input data
  survDataIn <- system.file("extdata/simSurvData.csv",
                            package = "BayesianCaribouDemographicProjection") %>%
    read.csv()
  ageRatio.herdIn <- system.file("extdata/simAgeRatio.csv",
                                 package = "BayesianCaribouDemographicProjection")%>%
    read.csv()
  disturbanceIn <- system.file("extdata/simDisturbance.csv",
                               package = "BayesianCaribouDemographicProjection")%>%
    read.csv()

  # default start year is outside range of data but still runs
  res1 <- expect_warning(runRMModel(Nchains = 1, Niter = 100, Nburn = 10, Nthin = 2))

  expect_true(is.na(res1$survInput$surv[1]))
  expect_s3_class(res1$result, "rjags")

  # end year is outside range of data but still runs
  res2 <- expect_warning(runRMModel(startYear = 2009, endYear = 2050, Nchains = 1, Niter = 100, Nburn = 10,
             Nthin = 2))

  expect_true(is.na(last(res2$survInput$surv)))
  expect_s3_class(res2$result, "rjags")

  # ageRatio.herd is outside year range warning but still runs
  res3 <- expect_warning(runRMModel(ageRatio.herd = mutate(ageRatio.herdIn, Year = Year - 30),
             startYear = 2009, endYear = 2040, Nchains = 1, Niter = 100, Nburn = 10,
             Nthin = 2), "composition")

  expect_s3_class(res3$result, "rjags")

  # all survival data is outside year range
  expect_error(
    runRMModel(survData = mutate(survDataIn, Year = Year - 30),
               startYear = 2009, endYear = 2040, Nchains = 1, Niter = 100, Nburn = 10,
               Nthin = 2),
    "None of the survival data")

  # survival should go to curYear but disturbance data should go to endYear
  # no warnings when survData is shorter
  expect_s3_class(
    runRMModel(survData = survDataIn,
               startYear = 2009, endYear = 2040, Nchains = 1, Niter = 100, Nburn = 10,
               Nthin = 2)$result,
    "rjags"
  )

  # warning when survData is missing a year in the middle
  expect_warning(
    expect_s3_class(
      runRMModel(survData = filter(survDataIn, Year != 2010),
                 startYear = 2009, endYear = 2040, Nchains = 1, Niter = 100, Nburn = 10,
                 Nthin = 2)$result,
      "rjags"
    ),
    "consecutive years")

  # all disturbance data is outside year range
  expect_warning(
    expect_error(
      runRMModel(disturbance = mutate(disturbanceIn, Year = Year - 50),
                 startYear = 2009, endYear = 2040, Nchains = 1, Niter = 100, Nburn = 10,
                 Nthin = 2),
      "None of the disturbance data")
  )

  # wrong column names
  expect_error(
    runRMModel(disturbance = rename(disturbanceIn, year = Year),
               startYear = 2009, Nchains = 1, Niter = 100, Nburn = 10,
               Nthin = 2),
    "missing expected columns")

  expect_error(
    runRMModel(ageRatio.herd =  rename(ageRatio.herdIn, cls = Class),
               startYear = 2009, Nchains = 1, Niter = 100, Nburn = 10,
               Nthin = 2),
    "missing expected columns")

  expect_error(
    runRMModel(survData = rename(survDataIn, events = enter),
               startYear = 2009, Nchains = 1, Niter = 100, Nburn = 10,
               Nthin = 2),
    "missing expected columns")

  # check haven't added need for Total_dist
  expect_s3_class(
    runRMModel(disturbance = select(disturbanceIn, -Total_dist),
               startYear = 2009, Nchains = 1, Niter = 100, Nburn = 10,
               Nthin = 2)$result,
    "rjags")
})

test_that("survAnalysisMethod works", {
  expect_message(out1 <- runRMModel(startYear = 2009, Nchains = 1, Niter = 100, Nburn = 10,
                            Nthin = 2),
                 "using Kaplan-Meier survival model")
  expect_s3_class(out1$result, "rjags")

  # TODO fix this error
  expect_message(out2 <- runRMModel(startYear = 2009, Nchains = 1, Niter = 100, Nburn = 10,
                            Nthin = 2, survAnalysisMethod = "Exponential"),
                 "using parametric exponential survival model")

  expect_s3_class(out2$result, "rjags")

  expect_message(out3 <- runRMModel(startYear = 2009, Nchains = 1, Niter = 100, Nburn = 10,
                            Nthin = 2, survAnalysisMethod = "other"),
                 "expanding survival record")

  expect_s3_class(out3$result, "rjags")
})

test_that("works when only 1 collared animal",{
  cowCounts <- data.frame(
    Year = 2012:2023,
    Count = 10,
    Class = "cow"
  )

  freqStartsByYear <- data.frame(
    Year = 2012:2023,
    numStarts = 1
  )

  scns <- fillDefaults(P = 12, st = 1)

  oo <- simulateObservations(scns, cowCounts = cowCounts,
                             freqStartsByYear = freqStartsByYear)

  # ensure some deaths so it uses KM still
  oo$simSurvObs$event[3] <- 1

  expect_warning(
    out <- runRMModel(
      survData = oo$simSurvObs, ageRatio.herd = oo$ageRatioOut,
      disturbance = oo$simDisturbance,
      startYear = 2012, endYear = 2043,
      Nchains = 1, Niter = 100, Nburn = 10,
      Nthin = 2),
    "low sample size")

  expect_s3_class(out$result, "rjags")

  # FIXED: error seems to happen when there are few collars but enough data for KM.
  # This was happening in some of the paper simulations too.
  # Error in `$<-.data.frame`(`*tmp*`, tau, value = c(18.0902177774918, 17.7911133740675,  :
  #                                                     replacement has 7 rows, data has 4

})
